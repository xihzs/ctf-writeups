# Quills Of Power

---

> Description: The Quills of Power is a magical artifact passed down for generations in the Jaga family to be retrieved in times of great need in the face of great security vulnerabilities. Help Jaga retrieve the Quills of Power from the Vault.
> 
> Difficulty: Easy
>
> Files: [qop-vault](./qop-vault)

---

## Playing around

Running the binary, we see the following output:

```sh
❯ ./qop-vault

This Vault contains the Quills of Power, great weapon of Jaga

Unlock in times of need, with the seeds of truth

You see a faint inscription of a map within the Vault...

n
 #
```

> You see a faint inscription of a map within the Vault...

This seems to suggest that there is something within this file.

If we run binwalk, we see that it contains a `map.py` file.

```python
import bs4
import requests


def map():
    url = 'https://www.tech.gov.sg/contact-us/'
    response = requests.get(url)
    soup = bs4.BeautifulSoup(response.content, 'html.parser')
    tag = soup.find(string='FIND DIRECTIONS').parent.parent.parent
    seeds = tag.attrs['href'].split('/')[6][1:].split(',')[:2]


if __name__ == '__main__':
    map()
```

If we print the seeds, we get `['1.3034259', '103.7663942']`.

The description hints that we can unlock something with these **seeds of truth**.


## Digging Deeper

Looking at the output of the binary, we also see some odd trailing characters.

Let's decompile the program to see what is going on under the hood.

```c
void __fastcall sub_1159(unsigned int *a1)
{
  int i; // [rsp+2Ch] [rbp-4h]

  srand(*a1);
  for ( i = 0; i <= 19; ++i )
    *(_DWORD *)&aU[4 * i] ^= rand();
}

__int64 __fastcall main(int a1, char **a2, char **a3)
{
  printf(format, a2, a3);
  printf(off_40C8);
  printf(off_40D0);
  sub_1159(off_40A8);
  sub_1159(a2022_0);
  printf("%-80s", aU);
  return 0LL;
}
```

It seems asides from printing all the text, the program also does some XORing and outputs the result at the end.

This explains the trailing characters, which come from the result of the XOR operations.

Since `srand()` funtion takes in a `seed`, which affects the type of numbers generated by `rand()`, we can change the `seeds` to the one that we obtained from `map.py`.

We first want to find the representation of the float in memory.

```python
from struct import pack
from binascii import hexlify
f1 = hexlify(pack(">f", 1.3034259))
f2 = hexlify(pack(">f", 103.7663942))
print(b'0x'+f1, b'0x'+f2)

# OUTPUT: b'0x3fa6d6a9' b'0x42cf8865'
```

We can then replace the seeds during runtime with a debugger like GDB.


## Runtime Manipulation

Looking at IDA, we can see that the call to `srand` is at an address offset of **0x116d**.

```
.text:0000000000001159                 push    rbp
.text:000000000000115A                 mov     rbp, rsp
.text:000000000000115D                 sub     rsp, 30h
.text:0000000000001161                 mov     [rbp+var_28], rdi
.text:0000000000001165                 mov     rax, [rbp+var_28]
.text:0000000000001169                 mov     eax, [rax]
.text:000000000000116B                 mov     edi, eax        ; seed
.text:000000000000116D                 call    _srand
.text:0000000000001172                 mov     [rbp+var_4], 0
.text:0000000000001179                 jmp     short loc_11AE
```

We can open the binary in GDB, and set a breakpoint at the srand function, and then run the program.

```
gef➤  break *srand
Breakpoint 1 at 0x1040
gef➤  run
```
On hitting our breakpoint, we want to modify the arguments to the function.

The first argument taken into a function in 64 bit assembly is stored in RDI. Thus we want to modify RDI to the seeds that we have found.

We can do this via the `set $rdi=0x3fa6d6a9` command.

We will repeat this for the next srand call, and eventually get our flag.

```
(gdb) break *srand
Breakpoint 1 at 0x1040
(gdb) c
The program is not being run.
(gdb) run
Starting program: /home/elmo/STF/RE/rev_qop/qop-vault
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/usr/lib/libthread_db.so.1".

This Vault contains the Quills of Power, great weapon of Jaga

Unlock in times of need, with the seeds of truth

You see a faint inscription of a map within the Vault...


Breakpoint 1, 0x00007ffff7df6400 in srandom () from /usr/lib/libc.so.6
(gdb) set $rdi=0x3fa6d6a9
(gdb) c
Continuing.

Breakpoint 1, 0x00007ffff7df6400 in srandom () from /usr/lib/libc.so.6
(gdb) set $rdi=0x42cf8865
(gdb) c
Continuing.
The Quills of Power have been revealed: STF22{Hom3.i5.Wh3r3.th3.Pow3r.li3s}     [Inferior 1 (process 40151) exited normally]


```
